<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Connection Test - Interviews.tv</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/dark-theme.css" rel="stylesheet">
    <style>
        .test-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .test-success {
            border-left: 4px solid #28a745;
        }
        .test-error {
            border-left: 4px solid #dc3545;
        }
        .test-loading {
            border-left: 4px solid #ffc107;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #FF0000;
        }
    </style>
</head>
<body class="bg-dark text-white">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-database text-danger me-2"></i>
                    Database Connection Test
                </h1>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="test-card p-3 text-center">
                            <div class="metric-value" id="total-users">-</div>
                            <div class="text-muted">Total Users</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="test-card p-3 text-center">
                            <div class="metric-value" id="total-interviews">-</div>
                            <div class="text-muted">Total Interviews</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="test-card p-3 text-center">
                            <div class="metric-value" id="total-views">-</div>
                            <div class="text-muted">Total Views</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="test-card p-3 text-center">
                            <div class="metric-value" id="total-likes">-</div>
                            <div class="text-muted">Total Likes</div>
                        </div>
                    </div>
                </div>

                <div class="test-card p-4 mb-4">
                    <h3>API Connection Tests</h3>
                    <div id="test-results">
                        <div class="test-item test-loading p-3 mb-2">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Testing API connection...
                        </div>
                    </div>
                </div>

                <div class="test-card p-4 mb-4">
                    <h3>Recent Interviews</h3>
                    <div id="interviews-list">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Loading interviews...
                        </div>
                    </div>
                </div>

                <div class="test-card p-4 mb-4">
                    <h3>Test User Login</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control bg-secondary text-white border-0" 
                                       id="test-email" value="john@example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control bg-secondary text-white border-0" 
                                       id="test-password" value="password123">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="testLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Test Login
                    </button>
                    <div id="login-result" class="mt-3"></div>
                </div>

                <div class="text-center">
                    <button class="btn btn-outline-light" onclick="runAllTests()">
                        <i class="fas fa-refresh me-2"></i>
                        Run All Tests
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        async function runAllTests() {
            await testApiConnection();
            await loadDashboardData();
            await loadInterviews();
        }

        async function testApiConnection() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            const tests = [
                { name: 'API Health Check', url: `${API_BASE}/test-platform.php` },
                { name: 'Database Features', url: `${API_BASE}/test-database-features.php` },
                { name: 'Dashboard Data', url: `${API_BASE}/dashboard-data.php` },
                { name: 'Interviews List', url: `${API_BASE}/interviews-list.php?limit=3` }
            ];

            for (const test of tests) {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-item test-loading p-3 mb-2';
                testDiv.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Testing ${test.name}...`;
                resultsDiv.appendChild(testDiv);

                try {
                    const response = await fetch(test.url);
                    const data = await response.json();
                    
                    if (data.success) {
                        testDiv.className = 'test-item test-success p-3 mb-2';
                        testDiv.innerHTML = `<i class="fas fa-check text-success me-2"></i>${test.name}: ✅ Success`;
                    } else {
                        testDiv.className = 'test-item test-error p-3 mb-2';
                        testDiv.innerHTML = `<i class="fas fa-times text-danger me-2"></i>${test.name}: ❌ ${data.message}`;
                    }
                } catch (error) {
                    testDiv.className = 'test-item test-error p-3 mb-2';
                    testDiv.innerHTML = `<i class="fas fa-times text-danger me-2"></i>${test.name}: ❌ ${error.message}`;
                }
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/dashboard-data.php`);
                const result = await response.json();
                
                if (result.success) {
                    const overview = result.data.user_analytics.overview;
                    document.getElementById('total-users').textContent = overview.total_followers;
                    document.getElementById('total-interviews').textContent = overview.total_interviews;
                    document.getElementById('total-views').textContent = overview.total_views.toLocaleString();
                    document.getElementById('total-likes').textContent = overview.total_likes;
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        async function loadInterviews() {
            try {
                const response = await fetch(`${API_BASE}/interviews-list.php?limit=5`);
                const result = await response.json();
                
                if (result.success) {
                    const interviews = result.data.interviews;
                    const listDiv = document.getElementById('interviews-list');
                    
                    listDiv.innerHTML = interviews.map(interview => `
                        <div class="border-bottom border-secondary pb-2 mb-2">
                            <h6 class="text-white">${interview.title}</h6>
                            <small class="text-muted">
                                By ${interview.creator_name} • ${interview.view_count_formatted} views • ${interview.created_at_formatted}
                            </small>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('interviews-list').innerHTML = 
                    `<div class="text-danger">Error loading interviews: ${error.message}</div>`;
            }
        }

        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const resultDiv = document.getElementById('login-result');
            
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing login...';
            
            try {
                const response = await fetch(`${API_BASE}/simple-auth.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check me-2"></i>
                            Login successful! Welcome, ${result.data.user.name} (${result.data.user.role})
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times me-2"></i>
                            Login failed: ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // Run tests on page load
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>
