<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Broadcasting Test - Interviews.tv</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF0000;
            --bg-dark: #1a1a1a;
            --card-dark: #2a2a2a;
            --input-dark: #3a3a3a;
            --text-light: #ffffff;
            --text-muted: #cccccc;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            background-color: var(--card-dark);
            border: 1px solid #444;
        }

        .form-control, .form-select {
            background-color: var(--input-dark);
            border: 1px solid #555;
            color: var(--text-light);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--input-dark);
            border-color: var(--primary-color);
            color: var(--text-light);
            box-shadow: 0 0 0 0.2rem rgba(255, 0, 0, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #cc0000;
            border-color: #cc0000;
        }

        .chat-container {
            display: flex;
            height: 400px;
            border: 1px solid #555;
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            background-color: var(--input-dark);
            padding: 1rem;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #555;
            background-color: var(--card-dark);
        }

        .message {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .message.api-message {
            border-left: 3px solid #007bff;
        }

        .message.websocket-message {
            border-left: 3px solid #28a745;
        }

        .message.system-message {
            border-left: 3px solid #ffc107;
            color: #ffc107;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }

        .test-log {
            background-color: #000;
            color: #00ff00;
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-broadcast-tower text-danger"></i>
                    Message Broadcasting Test
                </h1>
                <p class="text-center text-muted">
                    Test real-time message broadcasting between REST API and WebSocket server
                </p>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-wifi"></i> WebSocket Connection</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">WebSocket URL</label>
                            <input type="text" class="form-control" id="websocket-url" 
                                   value="ws://127.0.0.1:8080">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Auth Token</label>
                            <input type="text" class="form-control" id="auth-token" 
                                   value="test-token-123456">
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator" id="ws-status"></span>
                            <span id="ws-status-text">Disconnected</span>
                        </div>
                        <button class="btn btn-primary" id="connect-btn" onclick="connectWebSocket()">
                            <i class="fas fa-plug"></i> Connect
                        </button>
                        <button class="btn btn-secondary" id="disconnect-btn" onclick="disconnectWebSocket()" disabled>
                            <i class="fas fa-times"></i> Disconnect
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server"></i> API Connection</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">API Base URL</label>
                            <input type="text" class="form-control" id="api-url" 
                                   value="http://localhost:3000/api/simple-chat-api.php">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Room ID</label>
                            <input type="text" class="form-control" id="room-id" 
                                   value="broadcast-test-room">
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator" id="api-status"></span>
                            <span id="api-status-text">Not tested</span>
                        </div>
                        <button class="btn btn-success" onclick="testApiConnection()">
                            <i class="fas fa-check"></i> Test API
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-comments"></i> Real-time Chat Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <div class="message system-message">
                                    <strong>[SYSTEM]</strong> Message broadcasting test initialized...
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="message-input" 
                                           placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" onclick="sendViaWebSocket()">
                                        <i class="fas fa-paper-plane"></i> WebSocket
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="sendViaAPI()">
                                        <i class="fas fa-cloud"></i> API
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-flask"></i> Broadcasting Tests</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-primary me-2 mb-2" onclick="testAPIBroadcast()">
                            <i class="fas fa-broadcast-tower"></i> Test API → WebSocket
                        </button>
                        <button class="btn btn-outline-success me-2 mb-2" onclick="testWebSocketBroadcast()">
                            <i class="fas fa-wifi"></i> Test WebSocket → All
                        </button>
                        <button class="btn btn-outline-warning me-2 mb-2" onclick="simulateMultipleUsers()">
                            <i class="fas fa-users"></i> Simulate Multiple Users
                        </button>
                        <button class="btn btn-outline-info me-2 mb-2" onclick="testTypingIndicator()">
                            <i class="fas fa-keyboard"></i> Test Typing
                        </button>
                        <button class="btn btn-outline-danger me-2 mb-2" onclick="clearMessages()">
                            <i class="fas fa-trash"></i> Clear Messages
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Test Log</h5>
                    </div>
                    <div class="card-body">
                        <div class="test-log" id="test-log">
                            Message broadcasting test interface ready...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ws = null;
        let isConnected = false;
        let currentRoom = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'color: #ff6b6b' : 
                              type === 'success' ? 'color: #51cf66' : 'color: #74c0fc';
            
            logElement.innerHTML += `<div style="${colorClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addMessage(content, type = 'system') {
            const messagesElement = document.getElementById('chat-messages');
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.innerHTML = `<strong>[${timestamp}]</strong> ${content}`;
            
            messagesElement.appendChild(messageDiv);
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        function updateStatus(element, status, text) {
            const statusElement = document.getElementById(element);
            const textElement = document.getElementById(element.replace('-status', '-status-text'));
            
            statusElement.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        function connectWebSocket() {
            const url = document.getElementById('websocket-url').value;
            const token = document.getElementById('auth-token').value;
            const roomId = document.getElementById('room-id').value;
            
            updateStatus('ws', 'connecting', 'Connecting...');
            log('Connecting to WebSocket server...', 'info');
            
            ws = new WebSocket(url);
            
            ws.onopen = function() {
                updateStatus('ws', 'connected', 'Connected');
                log('WebSocket connected successfully', 'success');
                
                document.getElementById('connect-btn').disabled = true;
                document.getElementById('disconnect-btn').disabled = false;
                
                // Authenticate
                ws.send(JSON.stringify({
                    type: 'auth',
                    token: token
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                updateStatus('ws', 'disconnected', 'Disconnected');
                log('WebSocket disconnected', 'error');
                
                document.getElementById('connect-btn').disabled = false;
                document.getElementById('disconnect-btn').disabled = true;
                isConnected = false;
                currentRoom = null;
            };
            
            ws.onerror = function(error) {
                log('WebSocket error: ' + error, 'error');
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }

        function handleWebSocketMessage(data) {
            const type = data.type;
            
            switch (type) {
                case 'connected':
                    log('Received connection confirmation', 'success');
                    break;
                    
                case 'authenticated':
                    log('Authentication successful', 'success');
                    isConnected = true;
                    joinRoom();
                    break;
                    
                case 'room_joined':
                    currentRoom = data.room_id;
                    log(`Joined room: ${currentRoom}`, 'success');
                    addMessage(`Joined room: ${currentRoom}`, 'system');
                    break;
                    
                case 'message':
                    const msgData = data.data;
                    addMessage(`<strong>${msgData.user_name}:</strong> ${msgData.message}`, 'websocket');
                    log(`Received message from ${msgData.user_name}`, 'success');
                    break;
                    
                case 'user_joined':
                    addMessage(`${data.data.user_name} joined the room`, 'system');
                    break;
                    
                case 'user_left':
                    addMessage(`${data.data.user_name} left the room`, 'system');
                    break;
                    
                case 'typing':
                    if (data.data.is_typing) {
                        addMessage(`${data.data.user_name} is typing...`, 'system');
                    }
                    break;
                    
                case 'error':
                    log('WebSocket error: ' + data.message, 'error');
                    break;
            }
        }

        function joinRoom() {
            if (!isConnected) return;
            
            const roomId = document.getElementById('room-id').value;
            
            ws.send(JSON.stringify({
                type: 'join_room',
                room_id: roomId
            }));
        }

        async function testApiConnection() {
            const apiUrl = document.getElementById('api-url').value;
            
            updateStatus('api', 'connecting', 'Testing...');
            log('Testing API connection...', 'info');
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('api', 'connected', 'Connected');
                    log('API connection successful', 'success');
                } else {
                    updateStatus('api', 'disconnected', 'Failed');
                    log('API connection failed: ' + data.error, 'error');
                }
            } catch (error) {
                updateStatus('api', 'disconnected', 'Error');
                log('API connection error: ' + error.message, 'error');
            }
        }

        function sendViaWebSocket() {
            const message = document.getElementById('message-input').value.trim();
            if (!message || !isConnected) return;
            
            ws.send(JSON.stringify({
                type: 'message',
                room_id: currentRoom,
                message: message
            }));
            
            document.getElementById('message-input').value = '';
            log('Sent message via WebSocket', 'info');
        }

        async function sendViaAPI() {
            const message = document.getElementById('message-input').value.trim();
            if (!message) return;
            
            const apiUrl = document.getElementById('api-url').value;
            const roomId = document.getElementById('room-id').value;
            const token = document.getElementById('auth-token').value;
            
            try {
                const response = await fetch(`${apiUrl}/rooms/${roomId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        message_type: 'text'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(`<strong>API:</strong> ${message}`, 'api');
                    log('Message sent via API and should be broadcast to WebSocket', 'success');
                } else {
                    log('API message failed: ' + data.error, 'error');
                }
                
                document.getElementById('message-input').value = '';
                
            } catch (error) {
                log('API error: ' + error.message, 'error');
            }
        }

        function testAPIBroadcast() {
            document.getElementById('message-input').value = 'Test API → WebSocket broadcast';
            sendViaAPI();
        }

        function testWebSocketBroadcast() {
            document.getElementById('message-input').value = 'Test WebSocket broadcast';
            sendViaWebSocket();
        }

        function simulateMultipleUsers() {
            const messages = [
                'Hello from User 1!',
                'User 2 checking in',
                'User 3 here as well'
            ];
            
            messages.forEach((msg, index) => {
                setTimeout(() => {
                    document.getElementById('message-input').value = msg;
                    if (index % 2 === 0) {
                        sendViaAPI();
                    } else {
                        sendViaWebSocket();
                    }
                }, index * 1000);
            });
        }

        function testTypingIndicator() {
            if (!isConnected) return;
            
            ws.send(JSON.stringify({
                type: 'typing',
                room_id: currentRoom,
                is_typing: true
            }));
            
            setTimeout(() => {
                ws.send(JSON.stringify({
                    type: 'typing',
                    room_id: currentRoom,
                    is_typing: false
                }));
            }, 2000);
            
            log('Sent typing indicator', 'info');
        }

        function clearMessages() {
            document.getElementById('chat-messages').innerHTML = 
                '<div class="message system-message"><strong>[SYSTEM]</strong> Messages cleared</div>';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    sendViaAPI();
                } else {
                    sendViaWebSocket();
                }
            }
        }

        // Initialize
        log('Message broadcasting test interface ready');
        updateStatus('ws', 'disconnected', 'Disconnected');
        updateStatus('api', 'disconnected', 'Not tested');
    </script>
</body>
</html>
